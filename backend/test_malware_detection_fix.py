#!/usr/bin/env python3
"""
Test script to verify malware test site detection fix
Tests URL patterns and classification logic
"""

import sys
import json
sys.path.insert(0, r'c:\Users\vinee\Desktop\cyber-guard-ai-78\backend')

from real_time_threat_detector import RealTimeThreatDetector

def test_malware_detection():
    """Test malware site detection with pattern matching"""
    
    detector = RealTimeThreatDetector()
    
    print("\n" + "="*70)
    print("MALWARE DETECTION FIX VERIFICATION TEST")
    print("="*70)
    
    # Test cases
    test_cases = [
        {
            'url': 'https://wicar.org/test-malware.html',
            'expected_threat': 'MALICIOUS',
            'expected_pattern': True,
            'description': 'Known malware test site'
        },
        {
            'url': 'https://wicar.org/test-trojan.html',
            'expected_threat': 'MALICIOUS',
            'expected_pattern': True,
            'description': 'Known trojan test site'
        },
        {
            'url': 'https://example.com/malware-payload',
            'expected_pattern': True,
            'description': 'URL with malware keyword'
        },
        {
            'url': 'https://www.google.com',
            'expected_threat': 'SAFE',
            'expected_pattern': False,
            'description': 'Safe website'
        },
        {
            'url': 'https://github.com',
            'expected_threat': 'SAFE',
            'expected_pattern': False,
            'description': 'Safe website'
        }
    ]
    
    results = []
    
    for test in test_cases:
        print(f"\n{'-'*70}")
        print(f"Testing: {test['url']}")
        print(f"Description: {test['description']}")
        print(f"Expected Pattern Match: {test['expected_pattern']}")
        
        # Test pattern detection
        pattern_result = detector._check_url_patterns(test['url'])
        
        # Check if pattern detection is correct
        pattern_match = pattern_result.get('malicious') or pattern_result.get('suspicious')
        print(f"Pattern Match Result: {pattern_match}")
        
        if 'findings' in pattern_result and pattern_result['findings']:
            for finding in pattern_result['findings']:
                print(f"  -> {finding}")
        
        # Verify pattern detection matches expectation
        pattern_correct = pattern_match == test['expected_pattern']
        status_symbol = "PASS" if pattern_correct else "FAIL"
        print(f"Pattern Detection: {status_symbol}")
        
        # Note: Full detection requires API calls, so we just verify pattern detection
        results.append({
            'url': test['url'],
            'description': test['description'],
            'pattern_detection_pass': pattern_correct,
            'pattern_result': pattern_result
        })
    
    # Summary
    print(f"\n{'='*70}")
    print("TEST SUMMARY")
    print("="*70)
    
    passed = sum(1 for r in results if r['pattern_detection_pass'])
    total = len(results)
    
    print(f"Pattern Detection Tests: {passed}/{total} PASSED")
    
    if passed == total:
        print("\nALL TESTS PASSED! Malware detection fix is working correctly.")
        print("\nKey improvements:")
        print("  + URL pattern matching for malware test sites")
        print("  + Keyword detection in full URL path")
        print("  + Proper malicious marking for test sites")
        print("  + Lower classification thresholds")
    else:
        print(f"\nWARNING: {total - passed} test(s) failed!")
    
    print("\nDetailed Results:")
    print(json.dumps(results, indent=2))
    
    return passed == total

if __name__ == '__main__':
    success = test_malware_detection()
    sys.exit(0 if success else 1)
